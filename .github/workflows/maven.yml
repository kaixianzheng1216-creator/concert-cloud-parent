name: 持续集成与部署

on:
  push:
    branches: [ main ]

jobs:
  check-changes:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 检测文件变更
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            common:
              - 'pom.xml'
              - 'concert-common/**'
              - '.github/workflows/maven.yml'
            gateway: 'concert-gateway/**'
            auth: 'concert-auth/**'
            user: 'concert-user/**'
            product: 'concert-product/**'
            order: 'concert-order/**'
            pay: 'concert-pay/**'

      - name: 生成构建矩阵
        id: set-matrix
        run: |
          CHANGES='${{ steps.filter.outputs.changes }}'

          if [[ "${{ steps.filter.outputs.common }}" == 'true' ]]; then
            echo 'matrix=["gateway", "auth", "user", "product", "order", "pay"]' >> $GITHUB_OUTPUT
          else
            echo "matrix=$CHANGES" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: check-changes

    if: ${{ needs.check-changes.outputs.matrix != '[]' && needs.check-changes.outputs.matrix != '' }}

    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: ${{ fromJSON(needs.check-changes.outputs.matrix) }}
      max-parallel: 2

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Java 环境
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: 'maven'

      - name: Maven 打包
        run: mvn package -DskipTests -pl concert-${{ matrix.service }} -am

      - name: 登录 DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: concert-${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/concert-${{ matrix.service }}:latest

      - name: 远程部署
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/concert-${{ matrix.service }}:latest"
            CONTAINER_NAME="concert-${{ matrix.service }}"
            
            docker pull $IMAGE_NAME
            
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              --net=host \
              --cpus=0.5 \
              $IMAGE_NAME